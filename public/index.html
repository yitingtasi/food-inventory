<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ¥— é£Ÿæåº«å­˜ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0F0F1A;--surface:#1A1A2E;--surface2:#12121F;--border:#2A2A40;
  --text:#E8E8F0;--muted:#8888AA;--accent:#6366F1;--accent2:#8B5CF6;
  --green:#4ADE80;--yellow:#F59E0B;--red:#EF4444;
}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
input,select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;width:100%;outline:none;font-family:inherit;font-size:14px}
input:focus,select:focus{border-color:var(--accent)}
button{cursor:pointer;border:none;outline:none;font-family:inherit;transition:all .15s}
button:hover{transform:translateY(-1px)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;transition:all .2s}
.card:hover{border-color:#3A3A55;transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.tag{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:500}
.btn{padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-ghost{background:var(--border);color:var(--text)}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{to{transform:rotate(360deg)}}
.slide-in{animation:slideIn .25s ease}
.pulse{animation:pulse 2s infinite}
.spin{animation:spin 1s linear infinite;display:inline-block}
.modal-bg{position:fixed;inset:0;background:#000b;display:flex;align-items:center;justify-content:center;z-index:1000;padding:24px}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
#toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:500;z-index:2000;display:none;animation:slideIn .25s ease}
#sync-indicator{position:fixed;top:16px;right:16px;font-size:12px;padding:4px 10px;border-radius:20px;z-index:999;transition:all .3s}
header{background:linear-gradient(135deg,var(--surface) 0%,#16213E 100%);border-bottom:1px solid var(--border);padding:0 24px}
.header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
@media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,1fr)}.header-inner{flex-wrap:wrap;height:auto;padding:12px 0}}
.ing-card{padding:20px}
.progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;border-radius:2px;transition:width .3s}
.log-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #2A2A3A;font-size:13px}
</style>
</head>
<body>

<!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div id="sync-indicator" style="background:#4ADE8022;color:var(--green);border:1px solid #4ADE8044">âœ“ å·²åŒæ­¥</div>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-size:28px">ğŸ¥—</span>
      <div>
        <div style="font-family:'Space Mono',monospace;font-weight:700;font-size:18px;letter-spacing:1px">é£Ÿæåº«å­˜ç³»çµ±</div>
        <div style="font-size:11px;color:var(--accent);letter-spacing:2px">INVENTORY MANAGER</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span id="badge-empty" class="tag pulse" style="background:var(--red);color:#fff;display:none"></span>
      <span id="badge-low" class="tag" style="background:#F59E0B22;color:var(--yellow);border:1px solid #F59E0B44;display:none"></span>
      <button class="btn btn-ghost" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
      <button class="btn btn-primary" onclick="openAdd()">+ æ–°å¢é£Ÿæ</button>
    </div>
  </div>
</header>

<div style="max-width:1100px;margin:0 auto;padding:24px">
  <div class="stats-grid" id="stats"></div>
  <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap">
    <input id="search" placeholder="ğŸ” æœå°‹é£Ÿææˆ–ä½ç½®..." style="width:200px" oninput="render()" />
    <div id="cat-tabs" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    <button onclick="loadFromServer()" class="btn btn-ghost" style="margin-left:auto;font-size:12px">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>
  <div class="grid" id="cards"></div>
</div>

<div id="toast"></div>
<div id="modal-bg" class="modal-bg" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal slide-in" id="modal-content"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = "";  // åŒæºï¼Œç©ºå­—ä¸²å³å¯
const CATEGORIES = ["å…¨éƒ¨","ä¸»é£Ÿ","è›‹ç™½è³ª","è”¬èœ","è‚‰é¡","ä¹³è£½å“","èª¿å‘³æ–™","å…¶ä»–"];
const COLORS = ["#F59E0B","#60A5FA","#A78BFA","#F87171","#FB923C","#4ADE80","#F472B6","#34D399"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATEï¼ˆè¨˜æ†¶é«”ï¼Œè³‡æ–™ä¾†æºæ˜¯ä¼ºæœå™¨ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  ingredients: [],
  settings: { lineToken: "", lineUserId: "" },
  activeCategory: "å…¨éƒ¨",
  sentAlerts: new Set(),
  loading: true,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åŒæ­¥æŒ‡ç¤ºå™¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncStatus(status) {
  const el = document.getElementById("sync-indicator");
  if (status === "syncing") {
    el.style.background = "#F59E0B22"; el.style.color = "var(--yellow)"; el.style.borderColor = "#F59E0B44";
    el.innerHTML = '<span class="spin">âŸ³</span> åŒæ­¥ä¸­...';
  } else if (status === "ok") {
    el.style.background = "#4ADE8022"; el.style.color = "var(--green)"; el.style.borderColor = "#4ADE8044";
    el.textContent = "âœ“ å·²åŒæ­¥";
  } else if (status === "error") {
    el.style.background = "#EF444422"; el.style.color = "var(--red)"; el.style.borderColor = "#EF444444";
    el.textContent = "âœ— åŒæ­¥å¤±æ•—";
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¼ºæœå™¨ API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body) {
  setSyncStatus("syncing");
  try {
    const res = await fetch(API + path, {
      method,
      headers: { "Content-Type": "application/json" },
      body: body ? JSON.stringify(body) : undefined,
    });
    const data = await res.json();
    setSyncStatus("ok");
    return data;
  } catch (e) {
    setSyncStatus("error");
    showToast("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†", "warn");
    throw e;
  }
}

async function loadFromServer() {
  setSyncStatus("syncing");
  try {
    const res = await fetch("/api/data");
    const json = await res.json();
    if (json.success) {
      state.ingredients = json.data.ingredients || [];
      state.settings = json.data.settings || { lineToken: "", lineUserId: "" };
      setSyncStatus("ok");
      render();
      checkAlerts();
    }
  } catch (e) {
    setSyncStatus("error");
    showToast("ç„¡æ³•é€£ç·šä¼ºæœå™¨", "warn");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function calcFreq(logs) {
  const out = (logs || []).filter(l => l.type === "out");
  if (out.length < 2) return null;
  const first = new Date(out[0].date), last = new Date(out[out.length - 1].date);
  const days = Math.max(1, (last - first) / 864e5);
  return (out.reduce((s, l) => s + l.qty, 0) / days).toFixed(2);
}

function daysLeft(qty, freq) {
  if (!freq || freq <= 0) return null;
  return Math.floor(qty / freq);
}

function fmtDate(iso) {
  if (!iso) return "â€”";
  const d = new Date(iso);
  return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINE é€šçŸ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendLine(message) {
  if (!state.settings.lineToken || !state.settings.lineUserId) return;
  try {
    await fetch("/api/line-notify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: state.settings.lineToken, userId: state.settings.lineUserId, message }),
    });
  } catch (e) { console.error("LINE é€šçŸ¥å¤±æ•—:", e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åº«å­˜é‚è¼¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAlerts() {
  state.ingredients.forEach(item => {
    if (item.quantity <= item.minStock && item.quantity > 0) {
      const k = `low_${item.id}_${item.quantity}`;
      if (!state.sentAlerts.has(k)) {
        state.sentAlerts.add(k);
        sendLine(`âš ï¸ã€åº«å­˜è­¦å‘Šã€‘${item.emoji} ${item.name} åƒ…å‰© ${item.quantity} ${item.unit}ï¼Œè«‹ç›¡å¿«æ¡è³¼ï¼`);
      }
    }
    if (item.quantity === 0) {
      const k = `empty_${item.id}`;
      if (!state.sentAlerts.has(k)) {
        state.sentAlerts.add(k);
        sendLine(`ğŸš¨ã€åº«å­˜å‘Šæ€¥ã€‘${item.emoji} ${item.name} å·²ç”¨å®Œï¼Œè«‹ç«‹å³è£œè²¨ï¼`);
      }
    }
    const freq = calcFreq(item.logs);
    const days = daysLeft(item.quantity, freq);
    if (days !== null && days <= 3 && days > 0) {
      const k = `pred_${item.id}_${Math.floor(Date.now()/864e5)}`;
      if (!state.sentAlerts.has(k)) {
        state.sentAlerts.add(k);
        sendLine(`ğŸ“Šã€æ™ºæ…§é è­¦ã€‘${item.emoji} ${item.name} æŒ‰ä½¿ç”¨é »ç‡é è¨ˆ ${days} å¤©å¾Œç”¨å®Œï¼Œå»ºè­°æå‰æ¡è³¼ï¼`);
      }
    }
  });
}

async function adjustQty(id, delta, note = "") {
  const item = state.ingredients.find(i => i.id === id);
  if (!item) return;
  const newQty = Math.max(0, item.quantity + delta);
  const log = { id: uid(), type: delta > 0 ? "in" : "out", qty: Math.abs(delta), date: new Date().toISOString(), note };
  const updated = { ...item, quantity: newQty, logs: [...(item.logs || []), log] };
  // å…ˆæ›´æ–°ç•«é¢ï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
  state.ingredients = state.ingredients.map(i => i.id === id ? updated : i);
  render();
  // å†åŒæ­¥ä¼ºæœå™¨
  try {
    await api("PUT", `/api/data/ingredients/${id}`, updated);
    checkAlerts();
  } catch (e) {
    // å¤±æ•—å‰‡é‚„åŸ
    state.ingredients = state.ingredients.map(i => i.id === id ? item : i);
    render();
  }
}

async function addIngredient(data) {
  const item = {
    id: uid(), ...data,
    quantity: Number(data.quantity),
    minStock: Number(data.minStock),
    logs: [{ id: uid(), type: "in", qty: Number(data.quantity), date: new Date().toISOString(), note: "åˆå§‹å…¥åº«" }],
    createdAt: new Date().toISOString(),
  };
  state.ingredients = [...state.ingredients, item];
  render();
  await api("POST", "/api/data/ingredients/add", item);
  showToast(`${data.emoji} ${data.name} å·²æ–°å¢`, "success");
}

async function deleteItem(id, name) {
  if (!confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿ`)) return;
  state.ingredients = state.ingredients.filter(i => i.id !== id);
  render();
  await api("DELETE", `/api/data/ingredients/${id}`);
  showToast("é£Ÿæå·²åˆªé™¤", "info");
}

async function saveLocation(id) {
  const loc = document.getElementById("d-location").value.trim();
  state.ingredients = state.ingredients.map(i => i.id === id ? { ...i, location: loc } : i);
  render();
  const item = state.ingredients.find(i => i.id === id);
  await api("PUT", `/api/data/ingredients/${id}`, item);
  showToast("ğŸ“ ä½ç½®å·²æ›´æ–°", "success");
  openDetail(id);
}

async function saveSettings() {
  state.settings.lineToken = document.getElementById("s-token").value.trim();
  state.settings.lineUserId = document.getElementById("s-userid").value.trim();
  await api("POST", "/api/data/settings", state.settings);
  showToast("è¨­å®šå·²å„²å­˜", "success");
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const search = document.getElementById("search").value;
  const filtered = state.ingredients.filter(i => {
    const catOk = state.activeCategory === "å…¨éƒ¨" || i.category === state.activeCategory;
    const sOk = !search || i.name.includes(search) || (i.location && i.location.includes(search));
    return catOk && sOk;
  });

  const low = state.ingredients.filter(i => i.quantity <= i.minStock && i.quantity > 0);
  const empty = state.ingredients.filter(i => i.quantity === 0);

  document.getElementById("stats").innerHTML = [
    { label:"é£Ÿæç¸½æ•¸", value:state.ingredients.length, icon:"ğŸ“¦", color:"var(--accent)" },
    { label:"åº«å­˜å……è¶³", value:state.ingredients.filter(i=>i.quantity>i.minStock).length, icon:"âœ…", color:"var(--green)" },
    { label:"åº«å­˜è­¦å‘Š", value:low.length, icon:"âš ï¸", color:"var(--yellow)" },
    { label:"å·²ç”¨å®Œ", value:empty.length, icon:"ğŸš¨", color:"var(--red)" },
  ].map(s => `
    <div class="card" style="padding:16px 20px">
      <div style="font-size:24px;margin-bottom:4px">${s.icon}</div>
      <div style="font-size:28px;font-weight:700;color:${s.color};font-family:'Space Mono',monospace">${s.value}</div>
      <div style="font-size:13px;color:var(--muted);margin-top:2px">${s.label}</div>
    </div>`).join("");

  const be = document.getElementById("badge-empty");
  const bl = document.getElementById("badge-low");
  be.style.display = empty.length ? "" : "none"; be.textContent = `ğŸš¨ ${empty.length} é …å‘Šæ€¥`;
  bl.style.display = low.length ? "" : "none"; bl.textContent = `âš ï¸ ${low.length} é …ä½åº«å­˜`;

  document.getElementById("cat-tabs").innerHTML = CATEGORIES.map(c => `
    <button onclick="setCategory('${c}')" style="padding:6px 14px;border-radius:20px;font-size:13px;font-family:inherit;transition:all .15s;
      background:${state.activeCategory===c?"var(--accent)":"var(--surface)"};
      color:${state.activeCategory===c?"#fff":"var(--muted)"};
      border:1px solid ${state.activeCategory===c?"var(--accent)":"var(--border)"}">
      ${c}
    </button>`).join("");

  if (filtered.length === 0) {
    document.getElementById("cards").innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">ğŸŒ¿</div>æ‰¾ä¸åˆ°é£Ÿæï¼Œé»æ“Šã€Œæ–°å¢é£Ÿæã€é–‹å§‹ç®¡ç†</div>`;
    return;
  }

  document.getElementById("cards").innerHTML = filtered.map(item => {
    const freq = calcFreq(item.logs);
    const days = daysLeft(item.quantity, freq);
    const isEmpty = item.quantity === 0;
    const isLow = item.quantity <= item.minStock && !isEmpty;
    const pct = Math.min(100, (item.quantity / Math.max(1, item.minStock * 5)) * 100);
    const borderColor = isEmpty ? "var(--red)" : isLow ? "#F59E0B44" : "var(--border)";
    return `
    <div class="card ing-card slide-in" style="border-color:${borderColor}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div style="font-size:32px;margin-bottom:4px">${item.emoji}</div>
          <div style="font-weight:600;font-size:16px">${item.name}</div>
          <span class="tag" style="background:var(--border);color:var(--muted);margin-top:4px;display:inline-block">${item.category}</span>
          ${item.location ? `<div style="margin-top:6px;font-size:12px;color:#818CF8;display:flex;align-items:center;gap:4px"><span>ğŸ“</span><span>${item.location}</span></div>` : ""}
        </div>
        <div style="text-align:right">
          <div style="font-size:32px;font-weight:700;font-family:'Space Mono',monospace;color:${isEmpty?"var(--red)":isLow?"var(--yellow)":item.color}">${item.quantity}</div>
          <div style="font-size:12px;color:var(--muted)">${item.unit}</div>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${isEmpty?"var(--red)":isLow?"var(--yellow)":item.color}"></div></div>
      ${freq ? `<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“Š ä½¿ç”¨é »ç‡ ${freq}/å¤©${days!==null?`<span style="color:${days<=3?"var(--yellow)":"var(--green)"};margin-left:6px">Â· é è¨ˆå‰© ${days} å¤©</span>`:""}</div>` : ""}
      ${isEmpty ? `<div style="font-size:12px;padding:6px 10px;border-radius:8px;background:#EF444422;color:var(--red);margin-bottom:10px">ğŸš¨ åº«å­˜å·²ç”¨å®Œï¼</div>` :
        isLow ? `<div style="font-size:12px;padding:6px 10px;border-radius:8px;background:#F59E0B22;color:var(--yellow);margin-bottom:10px">âš ï¸ åº«å­˜åä½ï¼Œå»ºè­°æ¡è³¼</div>` : ""}
      <div style="display:flex;gap:6px">
        <button onclick="adjustQty('${item.id}',-1)" style="flex:1;padding:7px 0;background:var(--border);color:var(--text);border-radius:8px;font-size:16px;font-family:inherit">âˆ’</button>
        <button onclick="adjustQty('${item.id}',1)" style="flex:1;padding:7px 0;background:#6366F122;color:#818CF8;border:1px solid #6366F133;border-radius:8px;font-size:16px;font-family:inherit">+</button>
        <button onclick="openDetail('${item.id}')" style="padding:7px 10px;background:var(--border);color:var(--muted);border-radius:8px;font-size:13px;font-family:inherit">è©³æƒ…</button>
        <button onclick="deleteItem('${item.id}','${item.name}')" style="padding:7px 10px;background:#EF444411;color:var(--red);border-radius:8px;font-size:13px;font-family:inherit">âœ•</button>
      </div>
    </div>`;
  }).join("");
}

function setCategory(c) { state.activeCategory = c; render(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(html) {
  document.getElementById("modal-content").innerHTML = html;
  document.getElementById("modal-bg").style.display = "flex";
}
function closeModal() { document.getElementById("modal-bg").style.display = "none"; }

function openAdd() {
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-weight:700;font-size:18px">â• æ–°å¢é£Ÿæ</div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;gap:12px">
        <div style="flex:0 0 80px">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Emoji</label>
          <input id="f-emoji" value="ğŸ¥¬" style="text-align:center;font-size:24px" maxlength="2"/>
        </div>
        <div style="flex:1">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">é£Ÿæåç¨±</label>
          <input id="f-name" placeholder="ä¾‹ï¼šé›è›‹" />
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">é¡åˆ¥</label>
          <select id="f-cat">${CATEGORIES.filter(c=>c!=="å…¨éƒ¨").map(c=>`<option>${c}</option>`).join("")}</select>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">å–®ä½</label>
          <input id="f-unit" placeholder="å€‹/ç“¶/åŒ…" value="å€‹"/>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">åˆå§‹æ•¸é‡</label>
          <input id="f-qty" type="number" min="0" value="1"/>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">è­¦å‘Šé–¾å€¼</label>
          <input id="f-min" type="number" min="1" value="1"/>
        </div>
      </div>
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">ğŸ“ æ”¾ç½®ä½ç½®</label>
        <input id="f-location" placeholder="ä¾‹ï¼šå†°ç®±ä¸Šå±¤ã€ä¹¾è²¨æ«ƒç¬¬2æ’..."/>
      </div>
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:8px">é¡è‰²</label>
        <div style="display:flex;gap:8px" id="color-picker">
          ${COLORS.map((c,i)=>`<div onclick="selectColor('${c}')" data-color="${c}" style="width:28px;height:28px;border-radius:50%;background:${c};cursor:pointer;border:3px solid ${i===5?"#fff":"transparent"};transition:all .15s"></div>`).join("")}
        </div>
        <input type="hidden" id="f-color" value="${COLORS[5]}"/>
      </div>
      <button onclick="submitAdd()" class="btn btn-primary" style="padding:12px;border-radius:12px;font-size:15px;margin-top:4px">âœ“ æ–°å¢é£Ÿæ</button>
    </div>
  `);
}

function selectColor(c) {
  document.getElementById("f-color").value = c;
  document.querySelectorAll("#color-picker div").forEach(el => {
    el.style.borderColor = el.dataset.color === c ? "#fff" : "transparent";
  });
}

function submitAdd() {
  const name = document.getElementById("f-name").value.trim();
  if (!name) { showToast("è«‹è¼¸å…¥é£Ÿæåç¨±", "warn"); return; }
  addIngredient({
    name,
    emoji: document.getElementById("f-emoji").value || "ğŸ¥¬",
    category: document.getElementById("f-cat").value,
    unit: document.getElementById("f-unit").value || "å€‹",
    quantity: document.getElementById("f-qty").value || 0,
    minStock: document.getElementById("f-min").value || 1,
    color: document.getElementById("f-color").value || COLORS[0],
    location: document.getElementById("f-location").value.trim() || "",
  });
  closeModal();
}

function openDetail(id) {
  const item = state.ingredients.find(i => i.id === id);
  if (!item) return;
  const freq = calcFreq(item.logs);
  const days = daysLeft(item.quantity, freq);
  const logs = [...(item.logs || [])].reverse().slice(0, 20);
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:32px">${item.emoji}</span>
        <div>
          <div style="font-weight:700;font-size:18px">${item.name}</div>
          <div style="font-size:12px;color:var(--muted)">${item.category} Â· ${item.unit}</div>
          ${item.location ? `<div style="font-size:12px;color:#818CF8;margin-top:2px">ğŸ“ ${item.location}</div>` : ""}
        </div>
      </div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:${item.color};font-family:'Space Mono',monospace">${item.quantity} ${item.unit}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">ç›®å‰åº«å­˜</div>
      </div>
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:#818CF8;font-family:'Space Mono',monospace">${freq || "â€”"}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">ä½¿ç”¨é »ç‡/å¤©</div>
      </div>
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:${days!==null&&days<=3?"var(--red)":"var(--green)"};font-family:'Space Mono',monospace">${days !== null ? days+"å¤©" : "â€”"}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">é ä¼°å‰©é¤˜</div>
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:10px;font-size:14px">ğŸ“ æ”¾ç½®ä½ç½®</div>
      <div style="display:flex;gap:8px">
        <input id="d-location" value="${item.location||""}" placeholder="ä¾‹ï¼šå†°ç®±ä¸Šå±¤ã€ä¹¾è²¨æ«ƒç¬¬2æ’..."/>
        <button onclick="saveLocation('${id}')" style="padding:9px 14px;background:var(--accent);color:#fff;border-radius:10px;font-family:inherit;font-weight:600;white-space:nowrap">å„²å­˜</button>
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:12px;font-size:14px">ğŸ“¥ å…¥åº« / ğŸ“¤ å‡ºåº«</div>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="d-qty" type="number" min="1" value="1" style="width:80px"/>
        <input id="d-note" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰"/>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="doAdj('${id}',1)" style="flex:1;padding:9px;background:#4ADE8022;color:var(--green);border:1px solid #4ADE8033;border-radius:10px;font-weight:600;font-family:inherit">ğŸ“¥ å…¥åº«</button>
        <button onclick="doAdj('${id}',-1)" style="flex:1;padding:9px;background:#EF444422;color:var(--red);border:1px solid #EF444433;border-radius:10px;font-weight:600;font-family:inherit">ğŸ“¤ å‡ºåº«</button>
      </div>
    </div>
    <div>
      <div style="font-weight:600;margin-bottom:10px;font-size:14px">ğŸ“‹ å…¥å‡ºåº«è¨˜éŒ„</div>
      ${logs.length === 0 ? `<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px">æš«ç„¡è¨˜éŒ„</div>` :
        logs.map(l => `
        <div class="log-item">
          <div style="display:flex;align-items:center;gap:8px">
            <span>${l.type==="in"?"ğŸ“¥":"ğŸ“¤"}</span>
            <span style="color:${l.type==="in"?"var(--green)":"#F87171"}">${l.type==="in"?"+":"-"}${l.qty} ${item.unit}</span>
            ${l.note ? `<span style="color:var(--muted)">Â· ${l.note}</span>` : ""}
          </div>
          <span style="color:var(--muted)">${fmtDate(l.date)}</span>
        </div>`).join("")}
    </div>
  `);
}

function doAdj(id, sign) {
  const qty = Number(document.getElementById("d-qty").value) || 1;
  const note = document.getElementById("d-note").value;
  adjustQty(id, sign * qty, note);
  setTimeout(() => openDetail(id), 300);
}

function openSettings() {
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-weight:700;font-size:18px">âš™ï¸ ç³»çµ±è¨­å®š</div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="font-size:22px">ğŸ’¬</span>
        <div style="font-weight:600">LINE Messaging API è¨­å®š</div>
      </div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.7">
        1. å‰å¾€ <a href="https://developers.line.biz/console/" target="_blank" style="color:var(--accent)">LINE Developers Console</a> ç™»å…¥<br>
        2. å»ºç«‹ Provider â†’ å»ºç«‹ Messaging API Channel<br>
        3. ã€ŒMessaging APIã€é ç±¤ â†’ æœ€ä¸‹æ–¹ç”¢ç”Ÿ Channel Access Token<br>
        4. ã€ŒBasic settingsã€é ç±¤ â†’ è¤‡è£½ Your user ID<br>
        5. æƒæ QR Code å°‡ Bot åŠ ç‚º LINE å¥½å‹ï¼ˆå¿…è¦ï¼ï¼‰
      </div>
      <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Channel Access Token</label>
      <input id="s-token" type="password" value="${state.settings.lineToken||""}" placeholder="è²¼ä¸Š Channel Access Token" style="margin-bottom:10px"/>
      <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Your User ID</label>
      <input id="s-userid" value="${state.settings.lineUserId||""}" placeholder="ä¾‹ï¼šU1234567890abcdef" style="margin-bottom:10px"/>
      <div style="display:flex;gap:8px">
        <button onclick="saveSettings()" class="btn btn-primary" style="flex:1;padding:9px;border-radius:10px">å„²å­˜è¨­å®š</button>
        <button onclick="testLine()" style="padding:9px 14px;background:var(--border);color:var(--text);border-radius:10px;font-family:inherit">æ¸¬è©¦é€šçŸ¥</button>
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:12px">
      <div style="font-weight:600;margin-bottom:8px">ğŸ“Š æ™ºæ…§é€šçŸ¥è¦å‰‡</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.8">
        âœ… åº«å­˜ â‰¤ è­¦å‘Šé–¾å€¼ â†’ ä½åº«å­˜é€šçŸ¥<br>
        ğŸš¨ åº«å­˜æ­¸é›¶ â†’ ç·Šæ€¥è£œè²¨é€šçŸ¥<br>
        ğŸ“ˆ ä½¿ç”¨é »ç‡é æ¸¬å‰©é¤˜ â‰¤ 3 å¤© â†’ æå‰æ¡è³¼é è­¦
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px">
      <div style="font-weight:600;margin-bottom:8px">ğŸ”„ å¤šè£ç½®åŒæ­¥èªªæ˜</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.8">
        æ‰€æœ‰è³‡æ–™å„²å­˜æ–¼ä¼ºæœå™¨ï¼Œä»»ä½•è£ç½®é–‹å•Ÿç¶²å€å‡å¯å³æ™‚åŒæ­¥ã€‚<br>
        æ“ä½œå¾Œå³ä¸Šè§’é¡¯ç¤ºã€Œâœ“ å·²åŒæ­¥ã€ä»£è¡¨æˆåŠŸã€‚
      </div>
    </div>
  `);
}

async function testLine() {
  state.settings.lineToken = document.getElementById("s-token").value.trim();
  state.settings.lineUserId = document.getElementById("s-userid").value.trim();
  const res = await fetch("/api/line-notify", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token: state.settings.lineToken, userId: state.settings.lineUserId, message: "ğŸ§ª é£Ÿæåº«å­˜ç³»çµ± LINE é€šçŸ¥æ¸¬è©¦æˆåŠŸï¼" }),
  });
  const data = await res.json();
  if (data.success) showToast("âœ… LINE é€šçŸ¥å·²ç™¼é€", "success");
  else showToast("LINE ç™¼é€å¤±æ•—: " + data.error, "warn");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTimer;
function showToast(msg, type = "info") {
  const el = document.getElementById("toast");
  const colors = { success:["#4ADE8022","#4ADE80"], warn:["#F59E0B22","#F59E0B"], info:["#6366F122","#818CF8"] };
  const [bg, border] = colors[type] || colors.info;
  el.style.background = bg; el.style.border = `1px solid ${border}`; el.style.color = border;
  el.textContent = msg; el.style.display = "block";
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { el.style.display = "none"; }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è‡ªå‹•è¼ªè©¢ï¼ˆæ¯30ç§’åŒæ­¥ä¸€æ¬¡ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(() => {
  loadFromServer();
}, 30000);

// â”€â”€â”€ å•Ÿå‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadFromServer();
</script>
</body>
</html>

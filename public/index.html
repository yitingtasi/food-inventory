<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ¥— é£Ÿæåº«å­˜ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0F0F1A;--surface:#1A1A2E;--surface2:#12121F;--border:#2A2A40;
  --text:#E8E8F0;--muted:#8888AA;--accent:#6366F1;--accent2:#8B5CF6;
  --green:#4ADE80;--yellow:#F59E0B;--red:#EF4444;--orange:#FB923C;
}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
input,select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;width:100%;outline:none;font-family:inherit;font-size:14px}
input:focus,select:focus{border-color:var(--accent)}
button{cursor:pointer;border:none;outline:none;font-family:inherit;transition:all .15s}
button:hover{transform:translateY(-1px)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;transition:all .2s}
.card:hover{border-color:#3A3A55;transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.tag{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:500}
.btn{padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-ghost{background:var(--border);color:var(--text)}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.slide-in{animation:slideIn .25s ease}
.pulse{animation:pulse 2s infinite}
/* Modal */
.modal-bg{position:fixed;inset:0;background:#000b;display:flex;align-items:center;justify-content:center;z-index:1000;padding:24px}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
/* Toast */
#toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:500;z-index:2000;display:none;animation:slideIn .25s ease}
/* Header */
header{background:linear-gradient(135deg,var(--surface) 0%,#16213E 100%);border-bottom:1px solid var(--border);padding:0 24px}
.header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:12px}
/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
@media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,1fr)}.header-inner{flex-wrap:wrap;height:auto;padding:12px 0}}
/* Ingredient card */
.ing-card{padding:20px}
.progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;border-radius:2px;transition:width .3s}
/* Log list */
.log-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #2A2A3A;font-size:13px}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-size:28px">ğŸ¥—</span>
      <div>
        <div style="font-family:'Space Mono',monospace;font-weight:700;font-size:18px;letter-spacing:1px">é£Ÿæåº«å­˜ç³»çµ±</div>
        <div style="font-size:11px;color:var(--accent);letter-spacing:2px">INVENTORY MANAGER</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span id="badge-empty" class="tag pulse" style="background:var(--red);color:#fff;display:none"></span>
      <span id="badge-low" class="tag" style="background:#F59E0B22;color:var(--yellow);border:1px solid #F59E0B44;display:none"></span>
      <button class="btn btn-ghost" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
      <button class="btn btn-primary" onclick="openAdd()">+ æ–°å¢é£Ÿæ</button>
    </div>
  </div>
</header>

<div style="max-width:1100px;margin:0 auto;padding:24px">

  <!-- Stats -->
  <div class="stats-grid" id="stats"></div>

  <!-- Filter -->
  <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap">
    <input id="search" placeholder="ğŸ” æœå°‹é£Ÿæ..." style="width:180px" oninput="render()" />
    <div id="cat-tabs" style="display:flex;gap:6px;flex-wrap:wrap"></div>
  </div>

  <!-- Cards -->
  <div class="grid" id="cards"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Modal container -->
<div id="modal-bg" class="modal-bg" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal slide-in" id="modal-content"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = window.location.origin; // åŒæºå¾Œç«¯
const CATEGORIES = ["å…¨éƒ¨","ä¸»é£Ÿ","è›‹ç™½è³ª","è”¬èœ","è‚‰é¡","ä¹³è£½å“","èª¿å‘³æ–™","å…¶ä»–"];
const COLORS = ["#F59E0B","#60A5FA","#A78BFA","#F87171","#FB923C","#4ADE80","#F472B6","#34D399"];
const EMOJIS = ["ğŸ¥š","ğŸ¥›","ğŸš","ğŸ…","ğŸ—","ğŸ¥¦","ğŸ§…","ğŸ§„","ğŸ¥•","ğŸŒ½","ğŸ‹","ğŸ¥©","ğŸŸ","ğŸ«™","ğŸ§‚","ğŸ›¢ï¸"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  ingredients: load("fi_ingredients") || getDefaults(),
  lineToken: load("fi_line_token") || "",
  activeCategory: "å…¨éƒ¨",
  sentAlerts: new Set(load("fi_sent_alerts") || []),
};

function load(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{return null}}
function save(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}

function getDefaults(){
  const items=[
    {id:uid(),name:"é›è›‹",emoji:"ğŸ¥š",category:"è›‹ç™½è³ª",unit:"å€‹",quantity:6,minStock:1,color:"#F59E0B"},
    {id:uid(),name:"ç‰›å¥¶",emoji:"ğŸ¥›",category:"ä¹³è£½å“",unit:"ç“¶",quantity:2,minStock:1,color:"#60A5FA"},
    {id:uid(),name:"ç™½ç±³",emoji:"ğŸš",category:"ä¸»é£Ÿ",unit:"åŒ…",quantity:3,minStock:1,color:"#A78BFA"},
    {id:uid(),name:"ç•ªèŒ„",emoji:"ğŸ…",category:"è”¬èœ",unit:"é¡†",quantity:1,minStock:1,color:"#F87171"},
    {id:uid(),name:"é›èƒ¸è‚‰",emoji:"ğŸ—",category:"è‚‰é¡",unit:"ä»½",quantity:2,minStock:1,color:"#FB923C"},
    {id:uid(),name:"èŠ±æ¤°èœ",emoji:"ğŸ¥¦",category:"è”¬èœ",unit:"é¡†",quantity:0,minStock:1,color:"#4ADE80"},
  ];
  return items.map(i=>({...i,logs:[{id:uid(),type:"in",qty:i.quantity,date:new Date().toISOString(),note:"åˆå§‹å…¥åº«"}],createdAt:new Date().toISOString()}));
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2)}

function persist(){
  save("fi_ingredients", state.ingredients);
  save("fi_line_token", state.lineToken);
  save("fi_sent_alerts", [...state.sentAlerts]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINE NOTIFY  â† é€éå¾Œç«¯ä»£ç†ç™¼é€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendLine(message){
  if(!state.lineToken){showToast("è«‹å…ˆè¨­å®š LINE Notify Token","warn");return}
  try{
    const res = await fetch(`${API_BASE}/api/line-notify`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({token:state.lineToken,message})
    });
    const data = await res.json();
    if(data.success) showToast("âœ… LINE é€šçŸ¥å·²ç™¼é€","success");
    else showToast("LINE ç™¼é€å¤±æ•—: "+data.error,"warn");
  }catch(e){
    showToast("ç„¡æ³•é€£ç·šå¾Œç«¯ä¼ºæœå™¨","warn");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcFreq(logs){
  const out=(logs||[]).filter(l=>l.type==="out");
  if(out.length<2)return null;
  const first=new Date(out[0].date),last=new Date(out[out.length-1].date);
  const days=Math.max(1,(last-first)/864e5);
  return (out.reduce((s,l)=>s+l.qty,0)/days).toFixed(2);
}

function daysLeft(qty,freq){
  if(!freq||freq<=0)return null;
  return Math.floor(qty/freq);
}

function fmtDate(iso){
  if(!iso)return"â€”";
  const d=new Date(iso);
  return`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function checkAlerts(){
  state.ingredients.forEach(item=>{
    // Low stock
    if(item.quantity===item.minStock&&item.quantity>0){
      const k=`low_${item.id}_${item.quantity}`;
      if(!state.sentAlerts.has(k)){
        state.sentAlerts.add(k);
        sendLine(`âš ï¸ã€åº«å­˜è­¦å‘Šã€‘${item.emoji} ${item.name} åƒ…å‰© ${item.quantity} ${item.unit}ï¼Œè«‹ç›¡å¿«æ¡è³¼ï¼`);
      }
    }
    // Empty
    if(item.quantity===0){
      const k=`empty_${item.id}`;
      if(!state.sentAlerts.has(k)){
        state.sentAlerts.add(k);
        sendLine(`ğŸš¨ã€åº«å­˜å‘Šæ€¥ã€‘${item.emoji} ${item.name} å·²ç”¨å®Œï¼Œè«‹ç«‹å³è£œè²¨ï¼`);
      }
    }
    // Predictive
    const freq=calcFreq(item.logs);
    const days=daysLeft(item.quantity,freq);
    if(days!==null&&days<=3&&days>0){
      const k=`pred_${item.id}_${Math.floor(Date.now()/864e5)}`;
      if(!state.sentAlerts.has(k)){
        state.sentAlerts.add(k);
        sendLine(`ğŸ“Šã€æ™ºæ…§é è­¦ã€‘${item.emoji} ${item.name} æŒ‰ä½¿ç”¨é »ç‡é è¨ˆ ${days} å¤©å¾Œç”¨å®Œï¼Œå»ºè­°æå‰æ¡è³¼ï¼`);
      }
    }
  });
  persist();
}

function adjustQty(id, delta, note=""){
  state.ingredients = state.ingredients.map(item=>{
    if(item.id!==id)return item;
    const newQty=Math.max(0,item.quantity+delta);
    const log={id:uid(),type:delta>0?"in":"out",qty:Math.abs(delta),date:new Date().toISOString(),note};
    if(delta>0&&item.quantity===0) state.sentAlerts.delete(`empty_${id}`);
    return{...item,quantity:newQty,logs:[...(item.logs||[]),log]};
  });
  persist();
  checkAlerts();
  render();
}

function addIngredient(data){
  const item={
    id:uid(),...data,
    quantity:Number(data.quantity),
    minStock:Number(data.minStock),
    logs:[{id:uid(),type:"in",qty:Number(data.quantity),date:new Date().toISOString(),note:"åˆå§‹å…¥åº«"}],
    createdAt:new Date().toISOString()
  };
  state.ingredients=[...state.ingredients,item];
  persist();
  render();
  showToast(`${data.emoji} ${data.name} å·²æ–°å¢`,"success");
}

function deleteItem(id,name){
  if(!confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿ`))return;
  state.ingredients=state.ingredients.filter(i=>i.id!==id);
  persist();
  render();
  showToast("é£Ÿæå·²åˆªé™¤","info");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const search=document.getElementById("search").value;
  const filtered=state.ingredients.filter(i=>{
    const catOk=state.activeCategory==="å…¨éƒ¨"||i.category===state.activeCategory;
    const sOk=!search||i.name.includes(search);
    return catOk&&sOk;
  });

  // Stats
  const low=state.ingredients.filter(i=>i.quantity<=i.minStock&&i.quantity>0);
  const empty=state.ingredients.filter(i=>i.quantity===0);
  document.getElementById("stats").innerHTML=[
    {label:"é£Ÿæç¸½æ•¸",value:state.ingredients.length,icon:"ğŸ“¦",color:"var(--accent)"},
    {label:"åº«å­˜å……è¶³",value:state.ingredients.filter(i=>i.quantity>i.minStock).length,icon:"âœ…",color:"var(--green)"},
    {label:"åº«å­˜è­¦å‘Š",value:low.length,icon:"âš ï¸",color:"var(--yellow)"},
    {label:"å·²ç”¨å®Œ",value:empty.length,icon:"ğŸš¨",color:"var(--red)"},
  ].map(s=>`
    <div class="card" style="padding:16px 20px">
      <div style="font-size:24px;margin-bottom:4px">${s.icon}</div>
      <div style="font-size:28px;font-weight:700;color:${s.color};font-family:'Space Mono',monospace">${s.value}</div>
      <div style="font-size:13px;color:var(--muted);margin-top:2px">${s.label}</div>
    </div>`).join("");

  // Badges
  const be=document.getElementById("badge-empty");
  const bl=document.getElementById("badge-low");
  be.style.display=empty.length?"":"none"; be.textContent=`ğŸš¨ ${empty.length} é …å‘Šæ€¥`;
  bl.style.display=low.length?"":"none"; bl.textContent=`âš ï¸ ${low.length} é …ä½åº«å­˜`;

  // Category tabs
  document.getElementById("cat-tabs").innerHTML=CATEGORIES.map(c=>`
    <button onclick="setCategory('${c}')" style="padding:6px 14px;border-radius:20px;font-size:13px;font-family:inherit;transition:all .15s;
      background:${state.activeCategory===c?"var(--accent)":"var(--surface)"};
      color:${state.activeCategory===c?"#fff":"var(--muted)"};
      border:1px solid ${state.activeCategory===c?"var(--accent)":"var(--border)"}">
      ${c}
    </button>`).join("");

  // Cards
  if(filtered.length===0){
    document.getElementById("cards").innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">ğŸŒ¿</div>æ‰¾ä¸åˆ°é£Ÿæï¼Œé»æ“Šã€Œæ–°å¢é£Ÿæã€é–‹å§‹ç®¡ç†</div>`;
    return;
  }

  document.getElementById("cards").innerHTML=filtered.map(item=>{
    const freq=calcFreq(item.logs);
    const days=daysLeft(item.quantity,freq);
    const isEmpty=item.quantity===0;
    const isLow=item.quantity<=item.minStock&&!isEmpty;
    const pct=Math.min(100,(item.quantity/Math.max(1,item.minStock*5))*100);
    const borderColor=isEmpty?"var(--red)":isLow?"#F59E0B44":"var(--border)";
    return`
    <div class="card ing-card slide-in" style="border-color:${borderColor}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div style="font-size:32px;margin-bottom:4px">${item.emoji}</div>
          <div style="font-weight:600;font-size:16px">${item.name}</div>
          <span class="tag" style="background:var(--border);color:var(--muted);margin-top:4px;display:inline-block">${item.category}</span>
        </div>
        <div style="text-align:right">
          <div style="font-size:32px;font-weight:700;font-family:'Space Mono',monospace;color:${isEmpty?"var(--red)":isLow?"var(--yellow)":item.color}">${item.quantity}</div>
          <div style="font-size:12px;color:var(--muted)">${item.unit}</div>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${isEmpty?"var(--red)":isLow?"var(--yellow)":item.color}"></div></div>
      ${freq?`<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“Š ä½¿ç”¨é »ç‡ ${freq}/å¤©${days!==null?`<span style="color:${days<=3?"var(--yellow)":"var(--green)"};margin-left:6px">Â· é è¨ˆå‰© ${days} å¤©</span>`:""}
      </div>`:""}
      ${isEmpty?`<div style="font-size:12px;padding:6px 10px;border-radius:8px;background:#EF444422;color:var(--red);margin-bottom:10px">ğŸš¨ åº«å­˜å·²ç”¨å®Œï¼</div>`:
        isLow?`<div style="font-size:12px;padding:6px 10px;border-radius:8px;background:#F59E0B22;color:var(--yellow);margin-bottom:10px">âš ï¸ åº«å­˜åä½ï¼Œå»ºè­°æ¡è³¼</div>`:""}
      <div style="display:flex;gap:6px">
        <button onclick="adjustQty('${item.id}',-1)" style="flex:1;padding:7px 0;background:var(--border);color:var(--text);border-radius:8px;font-size:16px;font-family:inherit">âˆ’</button>
        <button onclick="adjustQty('${item.id}',1)" style="flex:1;padding:7px 0;background:#6366F122;color:#818CF8;border:1px solid #6366F133;border-radius:8px;font-size:16px;font-family:inherit">+</button>
        <button onclick="openDetail('${item.id}')" style="padding:7px 10px;background:var(--border);color:var(--muted);border-radius:8px;font-size:13px;font-family:inherit">è©³æƒ…</button>
        <button onclick="deleteItem('${item.id}','${item.name}')" style="padding:7px 10px;background:#EF444411;color:var(--red);border-radius:8px;font-size:13px;font-family:inherit">âœ•</button>
      </div>
    </div>`;
  }).join("");
}

function setCategory(c){state.activeCategory=c;render()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(html){
  document.getElementById("modal-content").innerHTML=html;
  document.getElementById("modal-bg").style.display="flex";
}
function closeModal(){document.getElementById("modal-bg").style.display="none"}

function openAdd(){
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-weight:700;font-size:18px">â• æ–°å¢é£Ÿæ</div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;gap:12px">
        <div style="flex:0 0 80px">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Emoji</label>
          <input id="f-emoji" value="ğŸ¥¬" style="text-align:center;font-size:24px" maxlength="2"/>
        </div>
        <div style="flex:1">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">é£Ÿæåç¨±</label>
          <input id="f-name" placeholder="ä¾‹ï¼šé›è›‹" />
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">é¡åˆ¥</label>
          <select id="f-cat">${CATEGORIES.filter(c=>c!=="å…¨éƒ¨").map(c=>`<option>${c}</option>`).join("")}</select>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">å–®ä½</label>
          <input id="f-unit" placeholder="å€‹/ç“¶/åŒ…" value="å€‹"/>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">åˆå§‹æ•¸é‡</label>
          <input id="f-qty" type="number" min="0" value="1"/>
        </div>
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">è­¦å‘Šé–¾å€¼</label>
          <input id="f-min" type="number" min="1" value="1"/>
        </div>
      </div>
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:8px">é¡è‰²</label>
        <div style="display:flex;gap:8px" id="color-picker">
          ${COLORS.map(c=>`<div onclick="selectColor('${c}')" data-color="${c}" style="width:28px;height:28px;border-radius:50%;background:${c};cursor:pointer;border:3px solid ${c==='#4ADE80'?'#fff':'transparent'};transition:all .15s"></div>`).join("")}
        </div>
        <input type="hidden" id="f-color" value="${COLORS[5]}"/>
      </div>
      <button onclick="submitAdd()" class="btn btn-primary" style="padding:12px;border-radius:12px;font-size:15px;margin-top:4px">âœ“ æ–°å¢é£Ÿæ</button>
    </div>
  `);
}

function selectColor(c){
  document.getElementById("f-color").value=c;
  document.querySelectorAll("#color-picker div").forEach(el=>{
    el.style.borderColor=el.dataset.color===c?"#fff":"transparent";
  });
}

function submitAdd(){
  const name=document.getElementById("f-name").value.trim();
  if(!name){showToast("è«‹è¼¸å…¥é£Ÿæåç¨±","warn");return}
  addIngredient({
    name,
    emoji:document.getElementById("f-emoji").value||"ğŸ¥¬",
    category:document.getElementById("f-cat").value,
    unit:document.getElementById("f-unit").value||"å€‹",
    quantity:document.getElementById("f-qty").value||0,
    minStock:document.getElementById("f-min").value||1,
    color:document.getElementById("f-color").value||COLORS[0],
  });
  closeModal();
}

function openDetail(id){
  const item=state.ingredients.find(i=>i.id===id);
  if(!item)return;
  const freq=calcFreq(item.logs);
  const days=daysLeft(item.quantity,freq);
  const logs=[...(item.logs||[])].reverse().slice(0,20);
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:32px">${item.emoji}</span>
        <div>
          <div style="font-weight:700;font-size:18px">${item.name}</div>
          <div style="font-size:12px;color:var(--muted)">${item.category} Â· ${item.unit}</div>
        </div>
      </div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:${item.color};font-family:'Space Mono',monospace">${item.quantity} ${item.unit}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">ç›®å‰åº«å­˜</div>
      </div>
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:#818CF8;font-family:'Space Mono',monospace">${freq||"â€”"}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">ä½¿ç”¨é »ç‡/å¤©</div>
      </div>
      <div style="background:var(--surface2);border-radius:12px;padding:14px;text-align:center">
        <div style="font-size:18px;font-weight:700;color:${days!==null&&days<=3?"var(--red)":"var(--green)"};font-family:'Space Mono',monospace">${days!==null?days+"å¤©":"â€”"}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">é ä¼°å‰©é¤˜</div>
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:12px;font-size:14px">ğŸ“¥ å…¥åº« / ğŸ“¤ å‡ºåº«</div>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="d-qty" type="number" min="1" value="1" style="width:80px"/>
        <input id="d-note" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰"/>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="doAdj('${id}',1)" style="flex:1;padding:9px;background:#4ADE8022;color:var(--green);border:1px solid #4ADE8033;border-radius:10px;font-weight:600;font-family:inherit">ğŸ“¥ å…¥åº«</button>
        <button onclick="doAdj('${id}',-1)" style="flex:1;padding:9px;background:#EF444422;color:var(--red);border:1px solid #EF444433;border-radius:10px;font-weight:600;font-family:inherit">ğŸ“¤ å‡ºåº«</button>
      </div>
    </div>
    <div>
      <div style="font-weight:600;margin-bottom:10px;font-size:14px">ğŸ“‹ å…¥å‡ºåº«è¨˜éŒ„</div>
      ${logs.length===0?`<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px">æš«ç„¡è¨˜éŒ„</div>`:
        logs.map(l=>`
        <div class="log-item">
          <div style="display:flex;align-items:center;gap:8px">
            <span>${l.type==="in"?"ğŸ“¥":"ğŸ“¤"}</span>
            <span style="color:${l.type==="in"?"var(--green)":"#F87171"}">${l.type==="in"?"+":"-"}${l.qty} ${item.unit}</span>
            ${l.note?`<span style="color:var(--muted)">Â· ${l.note}</span>`:""}
          </div>
          <span style="color:var(--muted)">${fmtDate(l.date)}</span>
        </div>`).join("")}
    </div>
  `);
}

function doAdj(id,sign){
  const qty=Number(document.getElementById("d-qty").value)||1;
  const note=document.getElementById("d-note").value;
  adjustQty(id,sign*qty,note);
  openDetail(id); // refresh
}

function openSettings(){
  openModal(`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-weight:700;font-size:18px">âš™ï¸ ç³»çµ±è¨­å®š</div>
      <button onclick="closeModal()" style="background:var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-family:inherit">âœ•</button>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="font-size:22px">ğŸ’¬</span>
        <div style="font-weight:600">LINE Notify è¨­å®š</div>
      </div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.7">
        1. å‰å¾€ <a href="https://notify-bot.line.me/zh_TW/" target="_blank" style="color:var(--accent)">LINE Notify å®˜ç¶²</a> ç™»å…¥<br>
        2. é»é¸ã€Œç™¼è¡Œæ¬Šæ–ã€ï¼Œè¨­å®šé€šçŸ¥ç¾¤çµ„<br>
        3. è¤‡è£½ Token è²¼åˆ°ä¸‹æ–¹å¾Œå„²å­˜
      </div>
      <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">LINE Notify Token</label>
      <input id="s-token" type="password" value="${state.lineToken}" placeholder="è²¼ä¸Šæ‚¨çš„ LINE Notify Token" style="margin-bottom:10px"/>
      <div style="display:flex;gap:8px">
        <button onclick="saveToken()" class="btn btn-primary" style="flex:1;padding:9px;border-radius:10px">å„²å­˜è¨­å®š</button>
        <button onclick="testLine()" style="padding:9px 14px;background:var(--border);color:var(--text);border-radius:10px;font-family:inherit">æ¸¬è©¦é€šçŸ¥</button>
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px">
      <div style="font-weight:600;margin-bottom:8px">ğŸ“Š æ™ºæ…§é€šçŸ¥è¦å‰‡</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.8">
        âœ… åº«å­˜ â‰¤ è­¦å‘Šé–¾å€¼ â†’ ä½åº«å­˜é€šçŸ¥<br>
        ğŸš¨ åº«å­˜æ­¸é›¶ â†’ ç·Šæ€¥è£œè²¨é€šçŸ¥<br>
        ğŸ“ˆ ä½¿ç”¨é »ç‡é æ¸¬å‰©é¤˜ â‰¤ 3 å¤© â†’ æå‰æ¡è³¼é è­¦
      </div>
    </div>
    <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-top:12px">
      <div style="font-weight:600;margin-bottom:8px">ğŸ–¥ï¸ å¾Œç«¯ä¼ºæœå™¨ç‹€æ…‹</div>
      <div id="server-status" style="font-size:13px;color:var(--muted)">æª¢æŸ¥ä¸­...</div>
    </div>
  `);
  checkServerHealth();
}

async function checkServerHealth(){
  const el=document.getElementById("server-status");
  if(!el)return;
  try{
    const res=await fetch(`${API_BASE}/api/health`);
    const d=await res.json();
    el.innerHTML=`<span style="color:var(--green)">âœ… ä¼ºæœå™¨æ­£å¸¸é‹è¡Œ</span> <span style="color:var(--muted)">Â· ${new Date(d.time).toLocaleTimeString("zh-TW")}</span>`;
  }catch{
    el.innerHTML=`<span style="color:var(--red)">âŒ ç„¡æ³•é€£ç·šä¼ºæœå™¨</span>`;
  }
}

function saveToken(){
  state.lineToken=document.getElementById("s-token").value.trim();
  persist();
  showToast("è¨­å®šå·²å„²å­˜","success");
  closeModal();
}

function testLine(){
  state.lineToken=document.getElementById("s-token").value.trim();
  persist();
  sendLine("ğŸ§ª é£Ÿæåº«å­˜ç³»çµ± LINE é€šçŸ¥æ¸¬è©¦æˆåŠŸï¼ç³»çµ±å·²æ­£ç¢ºè¨­å®šã€‚");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTimer;
function showToast(msg,type="info"){
  const el=document.getElementById("toast");
  const colors={success:["#4ADE8022","#4ADE80"],warn:["#F59E0B22","#F59E0B"],info:["#6366F122","#818CF8"]};
  const [bg,border]=colors[type]||colors.info;
  el.style.background=bg;
  el.style.border=`1px solid ${border}`;
  el.style.color=border;
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>{el.style.display="none"},3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
checkAlerts();
</script>
</body>
</html>
